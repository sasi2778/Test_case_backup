# Parameters
param(
    [string]$CsvDir = "F:\Nectar\CXA\liferay-ce-portal-7.4.3.78-ga78\test-case-data", # Directory where .csv files are stored
    [string]$GitLabApiUrl = "https://gitlab.com/api/v4/projects/2778/repository/files", # Project ID provided
    [string]$GitLabToken = "nectar_backup", # Provided GitLab token
    [string]$BranchName = "test-case-data-dev" # Set to "test-case-data-dev" or "test-case-data-live"
)

# Get all .csv files
$csvFiles = Get-ChildItem -Path $CsvDir -Filter *.csv

foreach ($file in $csvFiles) {
    # Use file name
    $fileName = $file.Name

    # Build GitLab API URI
    $apiUri = "$GitLabApiUrl/$($fileName.Replace('\', '/'))?branch=$BranchName"

    # Standard commit message
    $commitMessage = "nectar.2025"

    # Send the file directly as it exists to GitLab using the API
    $response = Invoke-RestMethod -Method PUT -Uri $apiUri -Headers @{
        "PRIVATE-TOKEN" = $GitLabToken
    } -Body @{
        "branch" = $BranchName;
        "file_path" = $fileName;
        "commit_message" = $commitMessage;
    }

    # Log the result
    if ($response) {
        Write-Host "Successfully backed up $fileName to branch $BranchName."
    } else {
        Write-Host "Failed to back up $fileName to branch $BranchName."
    }
}
